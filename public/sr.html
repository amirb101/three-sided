<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spaced Repetition Mode</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default,es6"></script>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(', '\\)'], ['$', '$']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> 
<link rel="stylesheet" href="styles/sr.css">
<body>
  <div class="top-bar">
    <a href="index.html" class="btn">‚Üê Back to Home</a>
  </div>

  <div class="container">
    <div class="header">
      <h1 class="page-title">Spaced Repetition</h1>
      <p class="page-subtitle">Master your flashcards with intelligent scheduling</p>
    </div>

    <div class="config-box" id="configBox">
      <h3>Start Your Study Session</h3>
      <div id="dueCardsInfo" class="due-cards-info" style="display: none;"></div>
      <div class="config-controls">
        <label for="maxCards">Cards this session:</label>
        <input type="number" id="maxCards" value="20" min="1" max="100">
        <button class="btn btn-primary" onclick="startSRSession()">
          <span>üöÄ</span> Start Session
        </button>
      </div>
    </div>

    <div class="card" id="srCard" onclick="flipCard()" style="display:none;">
      <div class="card-progress" id="cardProgress"></div>
      <div class="card-header">
        <div class="card-type" id="cardType">Statement</div>
      </div>
      <div class="card-content" id="cardContent">Click Start to begin</div>
      <div class="card-hint" id="cardHint">Click to reveal next section</div>
    </div>

    <div class="controls rating-controls" id="ratingControls" style="display: none;">
      <button class="btn btn-danger" onclick="rateCard(0)">
        <span>üòì</span> Again
      </button>
      <button class="btn btn-warning" onclick="rateCard(3)">
        <span>üòê</span> Hard
      </button>
      <button class="btn btn-success" onclick="rateCard(4)">
        <span>üòä</span> Good
      </button>
      <button class="btn btn-easy" onclick="rateCard(5)">
        <span>üòÑ</span> Easy
      </button>
    </div>

    <div class="controls" id="actionControls" style="display: none;">
      <button class="btn btn-secondary" onclick="undoRating()">
        <span>‚Ü∂</span> Undo Last Rating
      </button>
    </div>

    <div class="loading-indicator" id="loadingIndicator" style="display: none;">
      <div class="loading-spinner"></div>
      <p>Loading your flashcards...</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBU6LsdsoOTl6stATDTyeG4hmRohN9C9h0",
      authDomain: "three-sided-flashcard-app.firebaseapp.com",
      projectId: "three-sided-flashcard-app",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    let userId = null, allDueCards = [], srCards = [], srDocRefs = [], srIndex = 0, srSide = 0;
    let lastCard = null, lastDocId = null, lastSpacedBefore = null;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("Please log in first.");
        return;
      }
      
      userId = user.uid;
      document.getElementById('loadingIndicator').style.display = 'block';
      
      try {
        const snapshot = await db.collection("flashcards")
          .where("userId", "==", userId)
          .orderBy("createdAt", "desc")
          .get();

        const now = new Date();
        allDueCards = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const due = data.spaced?.dueDate?.toDate?.() || new Date(0);
          if (due <= now) {
            allDueCards.push({ data, id: doc.id });
          }
        });
        
        const dueCardsInfo = document.getElementById('dueCardsInfo');
        if (allDueCards.length > 0) {
          dueCardsInfo.innerHTML = `üìö ${allDueCards.length} cards are ready for review!`;
          dueCardsInfo.style.display = 'block';
        } else {
          dueCardsInfo.innerHTML = `‚úÖ No cards are due for review right now. Great job!`;
          dueCardsInfo.style.display = 'block';
        }
      } catch (error) {
        console.error("Error loading cards:", error);
        alert("Error loading your flashcards. Please try again.");
      } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
      }
    });

    function startSRSession() {
      if (allDueCards.length === 0) {
        alert("No cards are due for review!");
        return;
      }
      
      const max = parseInt(document.getElementById("maxCards").value) || 20;
      srIndex = 0;
      srSide = 0;
      srCards = allDueCards.slice(0, max).map(c => c.data);
      srDocRefs = allDueCards.slice(0, max).map(c => c.id);
      
      document.getElementById("srCard").style.display = "block";
      document.getElementById("configBox").style.display = "none";
      document.getElementById("actionControls").style.display = "block";
      
      showNextSRCard();
    }

    function showNextSRCard() {
      const cardEl = document.getElementById("srCard");
      const ratingControls = document.getElementById("ratingControls");
      const cardProgress = document.getElementById("cardProgress");
      const cardType = document.getElementById("cardType");
      const cardContent = document.getElementById("cardContent");
      const cardHint = document.getElementById("cardHint");

      if (srIndex >= srCards.length) {
        cardEl.innerHTML = `
          <div class="completion-card">
            <div class="completion-icon">üéâ</div>
            <div class="completion-title">Session Complete!</div>
            <div class="completion-stats">
              You reviewed ${srCards.length} flashcard${srCards.length !== 1 ? 's' : ''}
            </div>
            <div class="completion-actions">
              <button class="btn btn-primary" onclick="startSRSession()">
                <span>üîÑ</span> Start New Session
              </button>
              <a href="index.html" class="btn btn-secondary">
                <span>üè†</span> Back to Home
              </a>
            </div>
          </div>
        `;
        ratingControls.style.display = "none";
        document.getElementById("actionControls").style.display = "none";
        

        return;
      }

      srSide = 0;
      ratingControls.style.display = "none";
      
      const card = srCards[srIndex];
      cardProgress.textContent = `${srIndex + 1} / ${srCards.length}`;
      cardType.textContent = "Statement";
      cardContent.textContent = card.statement;
      cardHint.style.display = "block";
      cardHint.textContent = "Click to reveal hints";
      
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function flipCard() {
      if (srIndex >= srCards.length) return;

      const card = srCards[srIndex];
      const cardType = document.getElementById("cardType");
      const cardContent = document.getElementById("cardContent");
      const cardHint = document.getElementById("cardHint");
      const ratingControls = document.getElementById("ratingControls");

      srSide = (srSide + 1) % 3;

      if (srSide === 1) {
        cardType.textContent = "Hints";
        cardContent.textContent = card.hints || "No hints provided.";
        cardHint.textContent = "Click to reveal proof";
        ratingControls.style.display = "none";
      } else if (srSide === 2) {
        cardType.textContent = "Proof";
        cardContent.textContent = card.proof || "No proof provided.";
        cardHint.style.display = "none";
        ratingControls.style.display = "grid";
      } else {
        cardType.textContent = "Statement";
        cardContent.textContent = card.statement;
        cardHint.style.display = "block";
        cardHint.textContent = "Click to reveal hints";
        ratingControls.style.display = "none";
      }
      
      if (window.MathJax && window.MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function updateSM2(card, grade) {
      let { interval = 1, repetition = 0, easeFactor = 2.5 } = card.spaced || {};
      if (grade < 3) {
        repetition = 0;
        interval = 1;
      } else {
        repetition++;
        if (repetition === 1) interval = 1;
        else if (repetition === 2) interval = 6;
        else interval = Math.round(interval * easeFactor);
      }
      easeFactor = easeFactor + (0.1 - (5 - grade) * (0.08 + (5 - grade) * 0.02));
      if (easeFactor < 1.3) easeFactor = 1.3;
      const dueDate = new Date(Date.now() + interval * 24 * 60 * 60 * 1000);
      return { interval, repetition, easeFactor, dueDate: firebase.firestore.Timestamp.fromDate(dueDate) };
    }

    async function rateCard(grade) {
      if (srIndex >= srCards.length) return;
      
      lastCard = srCards[srIndex];
      lastDocId = srDocRefs[srIndex];
      lastSpacedBefore = lastCard.spaced || null;
      
      try {
        const updatedSpaced = updateSM2(lastCard, grade);
        await db.collection("flashcards").doc(lastDocId).update({ spaced: updatedSpaced });
        
        srIndex++;
        srSide = 0;
        showNextSRCard();
      } catch (error) {
        console.error("Error updating card:", error);
        alert("Error saving your progress. Please try again.");
      }
    }

    async function undoRating() {
      if (!lastCard || !lastDocId) {
        alert("Nothing to undo.");
        return;
      }
      
      try {
        await db.collection("flashcards").doc(lastDocId).update({ 
          spaced: lastSpacedBefore || firebase.firestore.FieldValue.delete() 
        });
        
        srIndex--;
        srSide = 0;
        showNextSRCard();
        
        // Clear undo state
        lastCard = null;
        lastDocId = null;
        lastSpacedBefore = null;
      } catch (error) {
        console.error("Error undoing rating:", error);
        alert("Error undoing the last action. Please try again.");
      }
    }
  </script>
</body>
</html>